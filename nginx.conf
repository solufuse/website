server {
  listen 80;
  server_name _;

  # This first location block handles the frontend application (your React app).
  location / {
    root /usr/share/nginx/html;
    try_files $uri $uri/ /index.html;
  }

  # This location block is for WebSocket connections.
  # A request to /api/chats/ws/123 becomes a proxied request to /ws/chats/123.
  location /api/chats/ws/ {
    proxy_pass https://api.solufuse.com/ws/chats/;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host api.solufuse.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # This is a general "catch-all" for all other API requests (the REST endpoints).
  # It proxies requests by stripping /api/ from the URL.
  # e.g., /api/users/123 becomes a request to https://api.solufuse.com/users/123
  location /api/ {
    proxy_pass https://api.solufuse.com/; # Trailing slash is key!

    proxy_set_header Host api.solufuse.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # Optional: Add headers to prevent caching of index.html for SPAs
  location = /index.html {
    root /usr/share/nginx/html;
    add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    expires off;
  }
}
