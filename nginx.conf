server {
  listen 80;
  server_name _;

  # This first location block handles the frontend application (your React app).
  location / {
    root /usr/share/nginx/html;
    try_files $uri $uri/ /index.html;
  }

  # This location block is crucial for WebSocket connections.
  # It targets the WebSocket endpoint and proxies it to your public API.
  location /chats/ws/ {
    # By adding /ws/ to the end of the proxy_pass URL, we are telling Nginx to
    # replace the matched part of the location (/chats/ws/) with /ws/.
    # So, a request to /chats/ws/123 becomes a proxied request to /ws/123.
    proxy_pass https://api.solufuse.com/ws/;

    # These headers are REQUIRED to upgrade the HTTP connection to a WebSocket connection.
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # These headers ensure the backend API receives the correct information.
    proxy_set_header Host api.solufuse.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https; # Let the backend know the original request was HTTPS
  }

  # This is a general "catch-all" for all other API requests (the REST endpoints).
  location ~ ^/(chats|users|projects|admin)/ {
    # We proxy all other API calls to your public backend.
    proxy_pass https://api.solufuse.com;

    # Set necessary headers
    proxy_set_header Host api.solufuse.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # Optional: Add headers to prevent caching of index.html for SPAs
  location = /index.html {
    root /usr/share/nginx/html;
    add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
    expires off;
  }
}
